# üíä MedGraphRAG

[![Python 3.11+](https://img.shields.io/badge/python-3.11+-blue.svg)](https://www.python.org/downloads/)
[![Neo4j](https://img.shields.io/badge/Neo4j-5.x-green.svg)](https://neo4j.com/)
[![Streamlit](https://img.shields.io/badge/Streamlit-1.28+-red.svg)](https://streamlit.io/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**A Patient-Centered Drug Interaction Analysis System using Custom GraphRAG**

MedGraphRAG is an AI-powered clinical decision support system that provides personalized medication safety analysis. Unlike traditional drug lookup tools that give identical warnings to everyone, MedGraphRAG considers patient-specific factors like age, kidney function, liver function, and current medications to generate personalized risk assessments.

üåê **[Live Demo](https://pranavkharat.github.io/medgraphrag/)** | üìÑ **[Documentation](./MedGraphRAG_Documentation.pdf)** | üé• **[Video Demo](#demo-video)**

---

## ‚ú® Key Features

| Feature | Description |
|---------|-------------|
| **Custom GraphRAG** | Built from scratch with Neo4j ‚Äî not a wrapper around existing frameworks |
| **Patient Personalization** | Risk scores adjusted for age, kidney/liver function, pregnancy, polypharmacy |
| **Text-to-Cypher Engine** | Natural language ‚Üí graph queries with self-healing retry mechanism |
| **Interactive Visualization** | PyVis-powered graph networks color-coded by severity |
| **LLM Explanations** | Plain-English explanations generated by local Llama 3.2 |
| **Synthetic Patient Database** | 752 realistic patient profiles for testing and demonstration |

---

## üèóÔ∏è Architecture

```
+-----------------------------------------------------------------------------+
|                           STREAMLIT UI (6 Tabs)                             |
|  Patient Analysis | Quick Check | Natural Language | Search | Pair | Browse |
+-----------------------------------------------------------------------------+
                                    |
                    +---------------+---------------+
                    |               |               |
                    v               v               v
+-----------------------+ +-----------------+ +-----------------------------+
|   PATIENT DATABASE    | | TEXT-TO-CYPHER  | |   POLYPHARMACY ANALYZER     |
|   (752 patients)      | | ENGINE          | |   - Risk scoring            |
|   - Demographics      | | - Few-shot      | |   - Patient adjustment      |
|   - Conditions        | | - Self-healing  | |   - Allergy checking        |
|   - Medications       | | - 3 retries     | |   - LLM explanations        |
+-----------------------+ +-----------------+ +-----------------------------+
                                   |
                                   v
+-----------------------------------------------------------------------------+
|                         NEO4J KNOWLEDGE GRAPH                               |
|                   1,701 Drugs  |  191,252 Interactions                      |
+-----------------------------------------------------------------------------+
                                   |
                    +--------------+--------------+
                    |              |              |
                    v              v              v
             +-----------+  +-----------+  +---------------+
             |   PyVis   |  |  Ollama   |  | Risk Scoring  |
             |  Graphs   |  |   LLM     |  |  Algorithm    |
             +-----------+  +-----------+  +---------------+
```

---

## üìä Performance Metrics

| Metric | Value |
|--------|-------|
| Overall Accuracy | **100%** (48/48 test cases) |
| First Attempt Success | 97.9% |
| Self-Healing Rate | 100% |
| Avg Response Time | 2.0 seconds |
| Drugs in Database | 1,701 |
| Drug Interactions | 191,252 |
| Synthetic Patients | 752 |

---

## üõ†Ô∏è Tech Stack

- **Database:** Neo4j 5.x (Knowledge Graph)
- **LLM:** Ollama + Llama 3.2 3B (Local inference)
- **Framework:** LangChain (Prompt management)
- **Visualization:** PyVis (Interactive graphs)
- **UI:** Streamlit (Web interface)
- **Container:** Docker (Neo4j orchestration)

---

## üìã Prerequisites

Before you begin, ensure you have the following installed:

- **Python 3.11+** ‚Äî [Download](https://www.python.org/downloads/)
- **Docker Desktop** ‚Äî [Download](https://www.docker.com/products/docker-desktop/)
- **Ollama** ‚Äî [Download](https://ollama.ai/)
- **Git** ‚Äî [Download](https://git-scm.com/)

### Hardware Requirements

| Component | Minimum | Recommended |
|-----------|---------|-------------|
| RAM | 8 GB | 16 GB |
| Storage | 5 GB | 10 GB |
| GPU | Not required | Metal (macOS) / CUDA (NVIDIA) |

---

## üöÄ Installation

### Step 1: Clone the Repository

```bash
git clone https://github.com/pranavkharat/medgraphrag.git
cd medgraphrag
```

### Step 2: Create Virtual Environment

```bash
# Create virtual environment
python -m venv venv

# Activate virtual environment
# On macOS/Linux:
source venv/bin/activate

# On Windows:
.\venv\Scripts\activate
```

### Step 3: Install Dependencies

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### Step 4: Start Neo4j Database

```bash
# Start Neo4j using Docker Compose
docker-compose up -d

# Verify Neo4j is running
docker ps
```

Neo4j will be available at:
- **Browser:** http://localhost:7474
- **Bolt:** bolt://localhost:7687
- **Credentials:** neo4j / password

### Step 5: Install and Configure Ollama

```bash
# Install Ollama (macOS)
brew install ollama

# OR download from https://ollama.ai/ for other platforms

# Pull the Llama 3.2 model
ollama pull llama3.2:3b

# Start Ollama server (in a separate terminal)
ollama serve
```

### Step 6: Configure Environment Variables

Create a `.env` file in the project root:

```bash
# .env
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=password
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama3.2:3b
```

### Step 7: Load Data into Neo4j

```bash
# Load drug interaction data into Neo4j
python -m src.ingestion.csv_parser
```

You should see output like:
```
Loading drug interactions...
Created 1,701 drug nodes
Created 191,252 interaction relationships
Data loading complete!
```

### Step 8: Generate Synthetic Patients

```bash
# Generate 752 synthetic patient profiles
python -m src.data.synthetic_patients
```

Output:
```
Generating synthetic patients...
Generated 752 patient profiles
Saved to data/synthetic/patients.json
```

### Step 9: Run the Application

```bash
streamlit run app/main.py
```

The application will open in your browser at **http://localhost:8501**

---

## üìÅ Project Structure

```
medgraphrag/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îî‚îÄ‚îÄ main.py                    # Streamlit UI (6 tabs)
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ raw/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db_drug_interactions.csv   # Source drug interaction data
‚îÇ   ‚îú‚îÄ‚îÄ synthetic/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ patients.json              # 752 synthetic patients
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_cases.json            # 48 evaluation test cases
‚îÇ   ‚îî‚îÄ‚îÄ evaluation/
‚îÇ       ‚îú‚îÄ‚îÄ metrics.json               # Evaluation results
‚îÇ       ‚îî‚îÄ‚îÄ evaluation_report.txt      # Human-readable report
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ patient.py                 # Patient dataclass + risk factors
‚îÇ   ‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ synthetic_patients.py      # Patient generator
‚îÇ   ‚îú‚îÄ‚îÄ analysis/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ polypharmacy_analyzer.py   # Risk scoring engine
‚îÇ   ‚îú‚îÄ‚îÄ visualization/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ graph_builder.py           # PyVis network generation
‚îÇ   ‚îú‚îÄ‚îÄ retrieval/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ text_to_cypher.py          # NL to Cypher engine
‚îÇ   ‚îú‚îÄ‚îÄ ingestion/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ csv_parser.py              # Data loader
‚îÇ   ‚îî‚îÄ‚îÄ evaluation/
‚îÇ       ‚îú‚îÄ‚îÄ synthetic_generator.py     # Test case generation
‚îÇ       ‚îî‚îÄ‚îÄ run_evaluation.py          # Evaluation harness
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ screenshot.png                 # App screenshot for landing page
‚îú‚îÄ‚îÄ .env                               # Environment variables
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ docker-compose.yml                 # Neo4j container config
‚îú‚îÄ‚îÄ requirements.txt                   # Python dependencies
‚îú‚îÄ‚îÄ MedGraphRAG_Documentation          # Full technical documentation
‚îú‚îÄ‚îÄ index.html                         # GitHub Pages landing page
‚îî‚îÄ‚îÄ README.md                          # This file
```

---

## üñ•Ô∏è Usage

### Starting the Services

Open three terminal windows:

**Terminal 1 ‚Äî Neo4j:**
```bash
cd medgraphrag
docker-compose up -d
```

**Terminal 2 ‚Äî Ollama:**
```bash
ollama serve
```

**Terminal 3 ‚Äî Streamlit:**
```bash
cd medgraphrag
source venv/bin/activate
streamlit run app/main.py
```

### Quick Start Commands

```bash
# Daily startup (all-in-one)
cd /path/to/medgraphrag
source venv/bin/activate
docker-compose up -d
ollama serve &
streamlit run app/main.py
```

### Using the Application

#### Tab 1: Patient Analysis
1. Search for a patient by name or ID
2. View patient demographics and risk factors
3. Click "Analyze Medications" for personalized risk assessment
4. View interaction graph and LLM-generated summary

#### Tab 2: Quick Check
1. Enter 2-10 medications
2. Get instant polypharmacy analysis
3. View all pairwise interactions

#### Tab 3: Natural Language
1. Ask questions like "What drugs interact with Warfarin?"
2. System converts to Cypher and queries Neo4j
3. Self-healing handles query failures automatically

#### Tab 4: Search Drug
1. Search for any drug by name
2. View all known interactions
3. Filter by severity level

#### Tab 5: Two Drugs
1. Select two drugs from dropdowns
2. Instant interaction check
3. View severity and description

#### Tab 6: Browse
1. Explore the drug database
2. View statistics and distributions
3. Random sampling for discovery

---

## üß™ Running Evaluation

```bash
# Make sure Neo4j and Ollama are running

# Run full evaluation suite
python -m src.evaluation.run_evaluation
```

**Output Files:**
- `data/evaluation/metrics.json` ‚Äî Machine-readable metrics
- `data/evaluation/evaluation_report.txt` ‚Äî Human-readable report

**Expected Results:**
```
Overall Accuracy:     100.0%
First Attempt Success: 97.9%
Self-Healing Rate:    100.0%
Avg Response Time:    2009 ms
```

---

## üîß Troubleshooting

### Neo4j Connection Issues

```bash
# Check if Neo4j is running
docker ps

# View Neo4j logs
docker-compose logs neo4j

# Restart Neo4j
docker-compose restart
```

### Ollama Not Responding

```bash
# Check if Ollama is running
curl http://localhost:11434/api/tags

# Restart Ollama
pkill ollama
ollama serve
```

### Import Errors

```bash
# Ensure all __init__.py files exist
touch src/__init__.py
touch src/models/__init__.py
touch src/data/__init__.py
touch src/analysis/__init__.py
touch src/visualization/__init__.py
touch src/retrieval/__init__.py
touch src/ingestion/__init__.py
touch src/evaluation/__init__.py
```

### Slow LLM Responses

- Use native Ollama installation (not Docker) for GPU acceleration
- Use `llama3.2:3b` instead of larger models
- Ensure Metal (macOS) or CUDA (NVIDIA) is available

### Neo4j Empty After Restart

```bash
# Reload data
python -m src.ingestion.csv_parser
```

---

## üìà Risk Scoring Algorithm

MedGraphRAG uses multiplicative risk adjustment based on patient factors:

```python
# Base score from interactions
base_score = (major * 10) + (moderate * 5) + (minor * 1)

# Patient-specific multipliers
if age >= 80: multiplier *= 1.6
if age >= 75: multiplier *= 1.5
if kidney == "failure": multiplier *= 2.0
if kidney == "severe": multiplier *= 1.6
if liver == "severe": multiplier *= 1.4
if pregnant: multiplier *= 1.5
if medications >= 10: multiplier *= 1.5

adjusted_score = base_score * multiplier
```

**Risk Levels:**
| Score | Level | Action |
|-------|-------|--------|
| ‚â• 70 | Critical | Immediate medication review |
| ‚â• 50 | High | Consult pharmacist |
| ‚â• 30 | Moderate | Monitor for symptoms |
| < 30 | Low | Standard precautions |

---

## üé• Demo Video

[Watch the 10-minute demo video](#) showing:
- Live system walkthrough
- Patient analysis demonstration
- Technical architecture explanation
- Performance analysis

---

## üìö Documentation

- **[Technical Documentation (PDF)](./DOCUMENTATION.pdf)** ‚Äî Full system architecture, implementation details, evaluation methodology
- **[Landing Page](https://pranavkharat.github.io/medgraphrag/)** ‚Äî Project showcase with interactive elements

---

## ü§ù Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit your changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

---

## üìÑ License

This project is licensed under the MIT License ‚Äî see the [LICENSE](LICENSE) file for details.

---

## ‚ö†Ô∏è Disclaimer

**This project is for educational purposes only.** MedGraphRAG is not a substitute for professional medical advice, diagnosis, or treatment. Always consult qualified healthcare professionals for medication-related decisions.

---

## üë§ Author

**Pranav Kharat**

- GitHub: [@pranavkharat](https://github.com/pranavkharat)
- LinkedIn: [Pranav Kharat](https://linkedin.com/in/pranavkharat)
- Institution: Northeastern University

---

## üôè Acknowledgments

- [DrugBank](https://go.drugbank.com/) ‚Äî Drug interaction data source
- [Neo4j](https://neo4j.com/) ‚Äî Graph database
- [Ollama](https://ollama.ai/) ‚Äî Local LLM inference
- [Streamlit](https://streamlit.io/) ‚Äî Web interface framework
- [LangChain](https://python.langchain.com/) ‚Äî LLM orchestration

---

<p align="center">
  Made with ‚ù§Ô∏è for safer medication management
</p>